pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/homework31']],
                          userRemoteConfigs: [[url: 'https://github.com/Hronologiya/AQA.git']]])
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    // Ensure Python is installed and available
                    sh '''
                        if ! command -v python3 &> /dev/null
                        then
                            echo "Python3 not found. Installing..."
                            apt update
                            apt install -y python3 python3-pip
                        fi
                    '''
                    // Install dependencies from requirements.txt
                    sh '/usr/bin/python3 -m pip install -r requirements.txt'
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    // Run the tests using pytest
                    sh '/usr/bin/python3 -m pytest tests/'
                }
            }
        }

        stage('Publish Results') {
            steps {
                script {
                    // Publish test results in JUnit format
                    junit 'tests/*.xml' // Save the JUnit test reports
                }
            }
        }
    }

    post {
        always {
            script {
                // Send email notification after the build completes (success or failure)
                emailext(
                    subject: "Build Result: ${currentBuild.currentResult}",
                    body: """<p>Build Status: ${currentBuild.currentResult}</p>
                             <p>Check build details in Jenkins.</p>""",
                    to: 'your-email@example.com',
                    from: 'jenkins@example.com',
                    replyTo: 'your-email@example.com',
                    mimeType: 'text/html'
                )
            }
        }
        failure {
            script {
                // Additional actions on build failure (optional)
                echo 'Build failed.'
            }
        }
    }
}
